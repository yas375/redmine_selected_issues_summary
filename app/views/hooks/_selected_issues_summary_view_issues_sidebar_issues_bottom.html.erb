<script type="text/javascript">
  document.observe("dom:loaded", function() {
    var estimated_hours = 0;
    var check_all = $$('table.issues thead tr th:nth-child(1) a img')[0];
    var issues_table = $$('table.issues');

    var update_selected_issue_stat = function(estimated, selected_issues) {
      if (selected_issues > 0) {
        if (estimated > 0) {
          $('estimated_time_value').update(estimated);
          $('total_estimated_time').show();
        }
        else {
          $('total_estimated_time').hide();
        }

        $('selected_issues_count').update(selected_issues);
        $('selected_issue_summary_time').show();
      }
      else {
        $('selected_issue_summary_time').hide();
      }
    }

    var time_counter = function(event){
      console.log(event.target)
      if (event.target == check_all) {
        estimated_hours = 0;
        var selected_issues = $$("tr.context-menu-selection").length;
        console.log(selected_issues)
        var a = $$('tr.context-menu-selection .estimated_hours');
        for (var i=0; i < a.length; i++) {
          if (a[i].innerHTML != '') {
            estimated_hours += parseFloat(a[i].innerHTML);
          }
        }
        estimated_hours = Math.round(estimated_hours*100)/100;
        update_selected_issue_stat(estimated_hours, selected_issues);
      } else {
        var parents = event.target.ancestors();
        var some_flag = false;
      for (var i=0; i<parents.length; i++) {
        console.log(i);
        if(parents[i].hasClassName('hascontextmenu')) {
          some_flag = true;
          break;
        }
        if (flag) {
          if (ctrl || checkbox) {

          } 
          else {
            // select current
            // проверить, что такой элемент есть, а то кононки со временем может и не быть
            var tr = parents[i].down('.estimated_hours');
            if (tr.innerHTML != '') {
              estimated_hours = parseFloat(tr.innerHTML);
            }
            else {
              estimated_hours = 0;
            }
            update_selected_issue_stat(estimated_hours,1);
          }
        } 
        else {
          estimated_hours = 0;
          update_selected_issue_stat(estimated_hours,0);
        }
      }
      }
    };

    document.body.observe('click', time_counter);
  });
</script>

<div id="selected_issue_summary_time" style="display: none; background: #507AAA; border:2px solid #666; color:#FFF; padding:10px; position:fixed; top:300px;">
  <%= t(:number_of_selected_issues) %>: <span id="selected_issues_count">0</span>
  <div id="total_estimated_time"><%= t(:field_estimated_hours) %>:  <span id="estimated_time_value">0</span></div>
</div>


